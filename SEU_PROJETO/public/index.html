<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Novetech · Painel de Acompanhamento de Cadastros</title>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>

  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <div class="header-content">
    <div class="header-brand">
        <img src="isotipo novetech - black.png" alt="Logo Novetech" class="header-icon" width="32" height="32">
        <img src="novetech logo black.png" alt="Logo Novetech" class="header-icon" width="32" height="32">
    </div>
    <p class="header-subtitle">Painel de Acompanhamento de Cadastros</p>
</div>
  </header>

  <main class="main-container">
    <section class="control-section" aria-label="Controles de importação e processamento">
      <div class="section-header">
        <h2>Importação de Dados</h2>
        <p class="section-description">Importe as planilhas de indivíduos e domicílios para análise</p>
      </div>

      <div class="control-container">
        <div class="snapshot-section">
          <div class="section-header" style="padding-bottom: 0.5rem; margin-bottom: 0.75rem;">
            <h4>Passo 1: Carregar Snapshot Anterior (Opcional)</h4>
            <p class="section-description" style="font-size: 0.8rem;">Envie o arquivo 'snapshot.json.gz' salvo da sua última análise para comparar.</p>
          </div>
          <div class="import-card" style="padding: 1rem;">
            <div class="import-card-header" style="margin-bottom: 0;">
              <svg class="import-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4m14-7l-5-5m0 0L7 8m5-5v12"/></svg>
              <h3>Snapshot Anterior</h3>
            </div>
            <label for="fileInputSnapshot" class="btn btn-secondary btn-file" style="background-color: #6B7280; color: white;">
              Carregar Snapshot (.json.gz)
            </label>
            <input type="file" id="fileInputSnapshot" accept=".gz,.json" style="display:none" />
            <span id="fileNameSnapshot" class="file-name">Nenhum snapshot carregado.</span>
          </div>
        </div>
        <div class="section-header" style="padding-bottom: 0.5rem; margin-bottom: 0.75rem;">
          <h4>Passo 2: Carregar Novas Planilhas</h4>
        </div>
        <div class="import-section">
          <div class="import-card">
            <div class="import-card-header">
              <svg class="import-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M23 21v-2a4 4 0 00-3-3.87m-4-12a4 4 0 010 7.75"/>
              </svg>
              <h3>Indivíduos</h3>
            </div>
            <label for="fileInputIndividuos" class="btn btn-primary btn-file">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4m14-7l-5-5m0 0L7 8m5-5v12"/>
              </svg>
              Selecionar Arquivo
            </label>
            <input type="file" id="fileInputIndividuos" accept=".csv,.xlsx,.xls" style="display:none" />
            <span id="fileNameIndividuos" class="file-name"></span>
          </div>

          <div class="import-card">
            <div class="import-card-header">
              <svg class="import-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
                <polyline points="9 22 9 12 15 12 15 22"/>
              </svg>
              <h3>Domicílios</h3>
            </div>
            <label for="fileInputDomicilios" class="btn btn-primary btn-file">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4m14-7l-5-5m0 0L7 8m5-5v12"/>
              </svg>
              Selecionar Arquivo
            </label>
            <input type="file" id="fileInputDomicilios" accept=".csv,.xlsx,.xls" style="display:none" />
            <span id="fileNameDomicilios" class="file-name"></span>
          </div>
        </div>

        <div class="section-header" style="padding-bottom: 0.5rem; margin-bottom: 0.75rem; margin-top: 1rem;">
          <h4>Passo 3: Processar e Salvar</h4>
        </div>
        <button id="btnProcessar" class="btn btn-primary btn-process">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="9 11 12 14 22 4"/>
            <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/>
          </svg>
          Processar Dados
        </button>
        <button id="btnSalvarSnapshot" class="btn btn-secondary btn-process" disabled style="align-self: flex-start; margin-top: 0.5rem; background-color: #10B981; color: white; border-color: #059669;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4m14-7l-5-5m0 0L7 8m5-5v12"/></svg>
          Salvar Snapshot Atual (Download)
        </button>
        </div>

      <div class="filters-section">
        <div class="section-header">
          <h2>Filtros</h2>
          <p class="section-description">Refine os resultados por unidade e profissional</p>
        </div>
        
        <div class="filters-container">
          <div class="filter-group">
            <label for="filterUnidade">
              <svg class="filter-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1"/>
              </svg>
              Unidade
            </label>
            <select id="filterUnidade" aria-label="Filtrar por unidade">
              <option value="">Todas as unidades</option>
            </select>
          </div>

          <div class="filter-group">
            <label for="filterProfissional">
              <svg class="filter-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
              </svg>
              Profissional (ACS)
            </label>
            <select id="filterProfissional" aria-label="Filtrar por profissional">
              <option value="">Todos os profissionais</option>
            </select>
          </div>

          <button id="btnPrint" class="btn btn-secondary">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 6 2 18 2 18 9"/>
              <path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/>
              <rect x="6" y="14" width="12" height="8"/>
            </svg>
            Gerar Relatório
          </button>
        </div>

        <div class="download-section">
          <div class="section-header">
            <h2>Download de Relatório Individual</h2>
            <p class="section-description">Selecione um profissional para gerar o relatório em PDF</p>
          </div>
          <div class="share-toolbar">
            <button id="btnLinkCoordenador" class="btn btn-secondary btn-share" title="Link amplo (coordenador)">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/>
                <line x1="8.59" y1="13.51" x2="15.41" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
              </svg>
              Gerar Link (Coordenador)
            </button>
            <button id="btnLinkGestor" class="btn btn-secondary btn-share" title="Link filtrado da Unidade">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1"/>
              </svg>
              Gerar Link (Gestor da Unidade)
            </button>
          </div>
    
          
          <div class="download-container">
            <div class="filter-group">
              <label for="selectProfissionalDownload">
                <svg class="filter-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                  <circle cx="12" cy="7" r="4"/>
                </svg>
                Selecionar Profissional
              </label>
              <select id="selectProfissionalDownload" aria-label="Selecionar profissional para download">
                <option value="">Selecione um profissional</option>
              </select>
            </div>

            <button id="btnGenerateLink" class="btn btn-secondary btn-share" disabled>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                </svg>
                Gerar Link
              </button>
            <button id="btnDownloadPDF" class="btn btn-primary btn-download" disabled>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              Baixar Relatório PDF
            </button>
          </div>
        </div>
      </div>
    </section>

    <section class="tabs-section" aria-label="Visualização de dados">
      <div class="tabs-container">
        <nav class="tabs-header" role="tablist" aria-label="Navegação de dados">
          <button class="tab-button active" data-tab="dashboard" role="tab" aria-selected="true" aria-controls="tab-dashboard">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
            </svg>
            <span>Dashboard</span>
          </button>
          <button class="tab-button" data-tab="individuos" role="tab" aria-selected="false" aria-controls="tab-individuos">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
              <circle cx="9" cy="7" r="4"/>
              <path d="M23 21v-2a4 4 0 00-3-3.87m-4-12a4 4 0 010 7.75"/>
            </svg>
            <span>Indivíduos</span>
          </button>
          <button class="tab-button" data-tab="domicilios" role="tab" aria-selected="false" aria-controls="tab-domicilios">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
              <polyline points="9 22 9 12 15 12 15 22"/>
            </svg>
            <span>Domicílios</span>
          </button>
          <button class="tab-button" data-tab="relatorio-unidade-ind" role="tab" aria-selected="false" aria-controls="tab-relatorio-unidade-ind">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1"/>
            </svg>
            <span>Rel. Unidade (Ind)</span>
          </button>
          <button class="tab-button" data-tab="relatorio-unidade-dom" role="tab" aria-selected="false" aria-controls="tab-relatorio-unidade-dom">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1"/>
            </svg>
            <span>Rel. Unidade (Dom)</span>
          </button>
          <button class="tab-button" data-tab="relatorio-prof-ind" role="tab" aria-selected="false" aria-controls="tab-relatorio-prof-ind">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
              <circle cx="12" cy="7" r="4"/>
            </svg>
            <span>Rel. Prof. (Ind)</span>
          </button>
          <button class="tab-button" data-tab="relatorio-prof-dom" role="tab" aria-selected="false" aria-controls="tab-relatorio-prof-dom">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
              <circle cx="12" cy="7" r="4"/>
            </svg>
            <span>Rel. Prof. (Dom)</span>
          </button>
          <button class="tab-button" data-tab="historico" role="tab" aria-selected="false" aria-controls="tab-historico">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="1" x2="12" y2="13"/>
              <path d="M12 1a11 11 0 11-11 11"/>
            </svg>
            <span>Histórico</span>
          </button>
          <button class="tab-button" data-tab="desaparecidos" role="tab" aria-selected="false" aria-controls="tab-desaparecidos">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" stroke-linecap="round" stroke-linejoin="round"/>
              <line x1="1" y1="1" x2="23" y2="23" stroke-width="3" />
            </svg>
            <span>Desaparecidos</span>
          </button>
          <button class="tab-button" data-tab="detalhesProfissional" role="tab" aria-selected="false" aria-controls="tab-detalhesProfissional" style="display:none;">
            <span>Detalhes Profissional</span>
          </button>
          <button class="tab-button" data-tab="detalhesUnidade" role="tab" aria-selected="false" aria-controls="tab-detalhesUnidade" style="display:none;">
            <span>Detalhes Unidade</span>
          </button>
        </nav>

        
        <div class="tab-content active" id="tab-dashboard" role="tabpanel" aria-labelledby="tab-dashboard">
          <div class="dashboard-layout">
            <div class="dashboard-kpis">
              <div class="kpi-card">
                <h3>Total de Cadastros</h3>
                <p class="kpi-main" id="kpiTotalCadastros">0</p>
                <p class="kpi-sub"><span id="kpiTotalIndividuos">0</span> indivíduos · <span id="kpiTotalDomicilios">0</span> domicílios</p>
              </div>
              <div class="kpi-card">
                <h3>Cadastros Críticos (&gt; 24 meses ou sem atualização)</h3>
                <p class="kpi-main" id="kpiCriticosTotal">0</p>
                <p class="kpi-sub">Indivíduos: <span id="kpiCriticosIndividuos">0</span> · Domicílios: <span id="kpiCriticosDomicilios">0</span></p>
              </div>
              <div class="kpi-card">
                <h3>Atualizados nos últimos 12 meses</h3>
                <p class="kpi-main" id="kpiAtualizados12m">0</p>
                <p class="kpi-sub">somando indivíduos e domicílios</p>
              </div>
              <div class="kpi-card">
                <h3>Microárea 00</h3>
                <p class="kpi-main" id="kpiMicroArea00">0</p>
                <p class="kpi-sub">cadastros associados à microárea 00</p>
              </div>
            </div>

            <div class="dashboard-chart-card">
              <div class="dashboard-chart-header">
                <h3>Distribuição por Tempo Sem Atualizar</h3>
                <p>Aplica automaticamente os filtros de Unidade e Profissional.</p>
              </div>
              <div class="dashboard-chart-body">
                <canvas id="dashboardChart" aria-label="Gráfico de distribuição por tempo sem atualizar" role="img"></canvas>
              </div>
            </div>
          </div>
        </div>

        <div class="tab-content" id="tab-individuos" role="tabpanel" aria-labelledby="tab-individuos">
          <div class="view-controls">
            <div class="search-container">
              <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/>
                <path d="M21 21l-4.35-4.35"/>
              </svg>
              <input type="text" id="searchIndividuos" placeholder="Pesquisar indivíduos ou profissionais..." aria-label="Pesquisar indivíduos" />
            </div>
            <button id="toggleIndividuosCriticos" class="btn btn-filter" aria-label="Alternar visualização">Mostrar Todos</button>
          </div>
          <div id="accordionIndividuosContainer" class="accordion-container">
          </div>
        </div>

        <div class="tab-content" id="tab-domicilios" role="tabpanel" aria-labelledby="tab-domicilios">
          <div class="view-controls">
            <div class="search-container">
              <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/>
                <path d="M21 21l-4.35-4.35"/>
              </svg>
              <input type="text" id="searchDomicilios" placeholder="Pesquisar domicílios ou profissionais..." aria-label="Pesquisar domicílios" />
            </div>
            <button id="toggleDomiciliosCriticos" class="btn btn-filter" aria-label="Alternar visualização">Mostrar Todos</button>
          </div>
          <div id="accordionDomiciliosContainer" class="accordion-container">
          </div>
        </div>

        <div class="tab-content" id="tab-relatorio-unidade-ind" role="tabpanel" aria-labelledby="tab-relatorio-unidade-ind">
          <div id="relatorioContainerInd" class="relatorio-container">
          </div>
        </div>
        
        <div class="tab-content" id="tab-relatorio-unidade-dom" role="tabpanel" aria-labelledby="tab-relatorio-unidade-dom">
          <div id="relatorioContainerDom" class="relatorio-container">
          </div>
        </div>

        <div class="tab-content" id="tab-relatorio-prof-ind" role="tabpanel" aria-labelledby="tab-relatorio-prof-ind">
          <div id="relatorioProfissionalContainerInd" class="relatorio-container">
          </div>
        </div>
        
        <div class="tab-content" id="tab-relatorio-prof-dom" role="tabpanel" aria-labelledby="tab-relatorio-prof-dom">
          <div id="relatorioProfissionalContainerDom" class="relatorio-container">
          </div>
        </div>

        <div class="tab-content" id="tab-historico" role="tabpanel" aria-labelledby="tab-historico">
            <h2>Evolução das Categorias de Atualização</h2>
            <p class="section-description" style="margin-bottom: 1.5rem;">
              Este gráfico mostra a contagem total de cadastros (indivíduos + domicílios) em cada categoria, 
              registrada a cada vez que o botão "Processar Dados" foi utilizado.
            </p>
            
            <div class="summary-charts-container">
                <div class="chart-container" style="height: 300px;">
                    <canvas id="historicoChart_0_4"></canvas>
                </div>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="historicoChart_5_12"></canvas>
                </div>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="historicoChart_13_24"></canvas>
                </div>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="historicoChart_25_plus"></canvas>
                </div>
            </div>

            <div id="historicoChartMessage" style="text-align: center; padding: 1rem; color: #555;"></div>
        </div>

        <div class="tab-content" id="tab-desaparecidos" role="tabpanel" aria-labelledby="tab-desaparecidos">
          <div class="section-header">
            <h2>Cadastros Desaparecidos</h2>
            <p class="section-description">
              Estes são os cadastros (por CPF ou ID do Domicílio) que existiam no processamento anterior,
              mas não foram encontrados nos arquivos processados agora.
            </p>
          </div>

          <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--border-color);">

          <div class="section-header" style="border-bottom: none; padding-bottom: 0;">
            <h3>Indivíduos Desaparecidos</h3>
          </div>
          <div class="view-controls">
            <div class="search-container">
              <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/>
                <path d="M21 21l-4.35-4.35"/>
              </svg>
              <input type="text" id="searchIndividuosDesaparecidos" placeholder="Pesquisar indivíduos ou profissionais..." aria-label="Pesquisar indivíduos desaparecidos" />
            </div>
            </div>
          <div id="accordionIndividuosDesaparecidosContainer" class="accordion-container" style="margin-bottom: 2rem;">
            </div>

          <div class="section-header" style="border-bottom: none; padding-bottom: 0;">
            <h3>Domicílios Desaparecidos</h3>
          </div>
          <div class="view-controls">
            <div class="search-container">
              <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/>
                <path d="M21 21l-4.35-4.35"/>
              </svg>
              <input type="text" id="searchDomiciliosDesaparecidos" placeholder="Pesquisar domicílios ou profissionais..." aria-label="Pesquisar domicílios desaparecidos" />
            </div>
          </div>
          <div id="accordionDomiciliosDesaparecidosContainer" class="accordion-container">
            </div>
        </div>

        <div class="tab-content" id="tab-detalhesProfissional" role="tabpanel" aria-labelledby="tab-detalhesProfissional">
        </div>

        <div class="tab-content" id="tab-detalhesUnidade" role="tabpanel" aria-labelledby="tab-detalhesUnidade">
        </div>
      </div>
    </section>
  </main>

  <div id="pdfContent" style="display:none;"></div>

  <script src="script.js"></script>
  <script src="script_link.js"></script>
</body>
</html>